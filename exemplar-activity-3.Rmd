---
title: 'Case Study 3: Geographic distribution of crime in Mexico'
author: "David Buil-Gil and Reka Solymosi"
date: "2024-01-25"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

CONTEXT

We take police-recorded crime data made available on the webside of the Mexican Government [https://www.gob.mx/sesnsp/acciones-y-programas/datos-abiertos-de-incidencia-delictiva?state=published](https://www.gob.mx/sesnsp/acciones-y-programas/datos-abiertos-de-incidencia-delictiva?state=published) to visualise kidnapping across the different states (entidades) of Mexico. 

We begin by loading the required packages in R:

```{r packages, message = FALSE, warning = FALSE}
library(here) # to identify the path to the data
library(readr) # to read in CSV data
library(dplyr) # for data wrangling
library(ggplot2) # for data visualisation
library(sf) # for spatial data manipulation and visualisation
library(viridis) # for colour schemes
```

The data are saved in a CSV (comme separated values) which make it easy load into an object called `data_Mexico`. We use the `read_csv()` function from the `readr` package.

```{r open data, message=FALSE}
#Read csv file with crime data
data_Mexico <- read_csv(here("data/IDM_nov2023.csv"))

```

We can have a look at the data and see there are a few variables of interest: 

- `TIPO` (crime type)
- `ANO` (year)
- `ENTIDAD` (state)

To visualise kidnappings we filter on the `TIPO` (crime type) variable for `SECUESTRO` (kidnapping). We filter for incidents in the year 2017 on the `ANO` variable.

```{r filter data}

data_Mexico <- data_Mexico %>%
  filter(TIPO == "SECUESTRO") %>% # select only kidnappings
  filter(ANO == 2017) # filter for year 2017 only

```

To plot the number of kidnappings per state on a map, we need to create a table which contains two columns: the state name (we can keep this as `ENTIDAD`) and the number of kidnappings for each one. We can see that the number of kidnappings are broken down by month: there is a new column for each month of the year. To get a total score for the year for each state, we must sum the numbers across these columns (these are columns 8 through 19, inclusive). We can use the `rowSums()` function, and specify the columns we need in the `accross()` function. Remember to set the `na.rm` parameter to `TRUE` to make sure that NAs (missing data) are just counted as 0 (no kidnappings in that month). 


```{r clean data}

data_Mexico <- data_Mexico %>%
  mutate(sum_secuestro = rowSums(across(8:19), # create new variable of sums
                                 na.rm = TRUE)) # treat NA as 0 here

```

Now we can count the number of total kidnappings in each entidad in 2017 by using the `group_by()` and `summarise()` functions to create a frequency table where each row represents one state. 
  
  
```{r calculate per state}

#Calculate number of crimes in each state
data_Mexico_states <- data_Mexico %>%
  group_by(ENTIDAD) %>% #group by state
  summarise(secuestro = sum(sum_secuestro)) # sum all kidnappings in the state

```

We have now saved this frequency table in a new object called `data_Mexico_states` which includes the count of kidnappings for each state in 2017. 

To explore the data before mapping we can look at the top 3 states with the most kidnappings: 


```{r}

top_n(data_Mexico_states, 3, secuestro)

```

Observe that the State of Mexico concentrates the largest number of kidnappings, 173, followed by Veracruz, with 172. 

We can look at the mean, median, standart deviation as well:

```{r}

mean(data_Mexico_states$secuestro)
median(data_Mexico_states$secuestro)
sd(data_Mexico_states$secuestro)

```

On average, 36 kidnappings were recorded in each of the 32 states of Mexico, however we see this is not evenly distributed. A histogram can help look at the skew:

```{r histogram, message=FALSE}

ggplot(data_Mexico_states, aes(x = secuestro)) + 
  geom_histogram() +
  theme_minimal()


```

We can see the top three states () all the way on the right there, far away from the rest of the country. Are these states particularly risky for kidnappings? To answer this we need to consider the rate of kidnappings per population, as it is possible that these are just the more populous states. Where there are more people, there are more of everything, even kidnappings! 

To account for this we can calculate rates of kidnappings per 100,000 residents. To do so we can download data about the population size for each state from the website of the National Institute of Statistics and Geography (INEGI): https://www.inegi.org.mx/app/tabulados/default.html?nc=mdemo02 

```{r population rate}

#Read csv file with population data
population <- read_csv(here("data/Population2010.csv"))

```

To link with our crime data, we can link the two tables using their common column for state, which is still `ENTIDAD` in our crime data, and is `STATE` in INEGI's population statistics. We use the `left_join()` function: 

```{r merge}

#Merge with crime data and calculate crime rates
data_Mexico_states <- data_Mexico_states %>%
  left_join(population, by = c("ENTIDAD" = "STATE")) %>%
  mutate(secuestro_rate = secuestro / Population2010 * 100000)

```

Let's look again: 

```{r}

top_n(data_Mexico_states, 3, secuestro_rate)

```

We can see new states appear according to calculated crime rates. However, Tamaulipas is here again, indicating it is high count and high rate for kidnapping. This might be a state of interest to consider for problem solving interventions aimed to reduce kidnapping. 

But how are these rates distributed in space? Are these ares near each other. It is important to realise that these places do not exist independently of one another, and spatial relationships can be best considered initially through a nice clear exploratory visualisation, such as a thematic map. 

Source of shapefile: https://github.com/strotgen/mexico-leaflet/

```{r load map, message = FALSE, warning = FALSE}

#Read geojson of Mexico states
#states_geojson <- st_read("https://github.com/strotgen/mexico-leaflet/blob/master/states.geojson")
states_geojson <- st_read(here("data/states.geojson"))

#Merge crime rates with geojson file
states_geojson <- states_geojson %>%
  mutate(state_name = toupper(state_name), #capital letters for consistency
         state_name = recode(state_name, #rename some states for consistency
                             'DISTRITO FEDERAL' = 'CIUDAD DE MEXICO',
                             'MÉXICO' = 'MEXICO',
                             'MICHOACÁN DE OCAMPO' = 'MICHOACAN',
                             'QUERÉTARO' = 'QUERETARO',
                             'SAN LUIS POTOSÍ' = 'SAN LUIS POTOSI',
                             'VERACRUZ DE IGNACIO DE LA LLAVE' = 'VERACRUZ',
                             'NUEVO LEÓN' = 'NUEVO LEON',
                             'COAHUILA DE ZARAGOZA' = 'COAHUILA',
                             'YUCATÁN' = 'YUCATAN')) %>% 
  left_join(data_Mexico_states, by = c("state_name" = "ENTIDAD"))


```


```{r visualise map no show, include = FALSE}

ggplot(data = states_geojson) +
  ggtitle("Rate of kidnappings per 100,000 residents in Mexico states") +
  geom_sf(aes(fill = secuestro_rate)) +
  scale_fill_viridis(option = "magma")+
  theme_void()

ggsave(here("exemplar-activities/Mexico_map.png"), 
       width = 10, height = 7)

```


```{r visualise map show, message = FALSE, fig.show = 'hide'}

ggplot(data = states_geojson) +
  ggtitle("Kidnappings in Mexico by states") +
  geom_sf(aes(fill = secuestro_rate)) +
  scale_fill_viridis(option = "magma", name= "Number of kidnappings per 100,000 population")+
  theme_void() +
   theme(legend.position="top")

```


```{r visualise map display, echo = FALSE}

knitr::include_graphics(here("exemplar-activities/Mexico_map.png"))

```

XXXX interpret


**References**


https://link.springer.com/article/10.1007/s12117-012-9185-x
https://doi.org/10.1080/17440572.2011.632499
https://doi.org/10.1016/j.ijlcj.2021.100479 

